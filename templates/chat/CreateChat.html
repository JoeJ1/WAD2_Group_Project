{% extends 'chat/chattemplates.html'%}
{% load staticfiles %}

{% block title_block %}
    Create chats
{% endblock %}

{% block includes_block %}
{% endblock %}

{% block content_title %}
Create New Chat
{% endblock %}


{% block content_block %}

<form id="user_form" method="post" action="" enctype="multipart/form-data">
{% csrf_token %}
<div class="container-fluid p-2 g-2 box">
  <div class="row g-5 justify-content-center align-items-top myrows mb-3">
    <div class="col">
      <div class = "mycol">Members added
        <div>
          <ul class = "list-group" id="memberList"></ul>
        </div>
      </div>
      </div>
    <div class="col">
      <div class="container-fluid" style="padding:0px;">
        <div class = "mycol" style="margin-bottom:10px;">
          <div class="mb-3">
          <label for="ChatName" class="form-label">Chat Name</label>
          <input type="text" class="form-control" id="ChatName" name="name" placeholder="Enter Chat Name" required>
        </div>
      </div>
        <div class = "mycol">
          <div class="mb-3">
            <label for="Chat-title" class="form-label" >Chat Description</label>
            <input type="text" class="form-control" name="description" id="title" placeholder="Enter Chat Description" required>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="row g-6 justify-content-center align-items-top myrows mb-3">
    <div class="col mb-3">
      <div class="mycol">
        <label for="ChatName" class="form-label">Add Member</label>
        <div class="input-group mb-3">
          <input type="text" id="memberInput" class="form-control" placeholder="Enter Member Name">
          <button class="btn btn-primary" type="button" id="addMemberButton">Add</button>
        </div>
        <input type="hidden" id="memberListInput" name="user_list" value="">
        {% for user in all_users %}
            <input type="hidden" name="users" value="{{ user.id }}">
        {% endfor %} 
        <input type="hidden" name="owner" value="{{ request.user.userprofile.id }}"> 

        <script>
          const memberInput = document.getElementById("memberInput");
          const addMemberButton = document.getElementById("addMemberButton");
          const memberListInput = document.getElementById("memberListInput");
          const members = [];
          
          var usernames = JSON.parse('{{ usernames|escapejs }}');
          const currentUser = JSON.parse('{{ current_user|escapejs }}')
          addMemberButton.addEventListener("click", function() {
            const memberName = memberInput.value;
            if (memberName !== "") {
              const user = usernames.find(u => u === memberName);
              if (user) {
                if (members.includes(user)){
                  alert(`User ${memberName} is already in the chat.`);
                } 
                else if (user === currentUser) {
                  alert(`You cannot add yourself to the chat.`);
                }
                else {
                  members.push(user);
                  memberInput.value = "";
                  renderMembers();
                  updateMemberListInput();
                }
            } else {
                alert(`User ${memberName} not found.`);
            }
            }
          });
          
          function renderMembers() {
            memberList.innerHTML = "";
            for (let i = 0; i < members.length; i++) {
              const li = document.createElement("li");
              const close = document.createElement("a");
              close.classList.add('btn-close');
              close.classList.add('float-end');
              close.onclick=function(){
                  members.splice(i,1);
                  renderMembers();
              }
              li.textContent = members[i];
              li.classList.add('list-group-item');
              li.appendChild(close);
              memberList.appendChild(li);
            }
          }

          function updateMemberListInput() {
            memberListInput.value = JSON.stringify(members);
          }
        </script>

      </div>
    </div>
    <div class="col">
      <div class = "mycol">
        <label for="UploadImage" class="form-label">Upload Background Image</label>
        <input class="form-control" name="image" id="UploadImage" type="file">
      </div>
    </div>
  </div>
  <div class="row justify-content-center align-items-top myrows mb-3">
    <div class="col-1 justify-content-center align-items-center">
      <button class="btn btn-primary" type="submit">Create</button>
    </div>
  </div>
</div>
</form>
{% endblock %}
