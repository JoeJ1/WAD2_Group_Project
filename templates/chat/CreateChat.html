{% extends 'chat/chattemplates.html'%}
{% load staticfiles %}

{% block title_block %}
    Create chats
{% endblock %}

{% block includes_block %}
<style>
.box-size{
  height:fit-content;
  width:55rem;
  border:2px solid #91b1f7;
  border-radius: 20px;
  padding:15px;
  background-color: #91b1f7;
  color:#fff;
}
.center{
  height: 25vh;
  width: 300px;
  position: relative;
}
.box {
  color:white;
  background-color: var(--main-col);
  border-radius: 20px;
  width:80%;
  margin-top: 2rem;
}
.mycol{
  background-color: #ffff;
  color:#91b1f7;
  padding: 10px;
  padding-left:15px;
  padding-right:15px;
  border-radius: 10px;
}
.lists{
  list-style-type: none;
   margin:0;padding:0;
    height:100px;
    overflow:hidden; overflow-y:scroll;
}

.close-button{
  color:inherit; !important;
  text-decoration:none; !important;
  line-height: inherit; !important;
}

.close-button:hover{
  cursor:pointer;
}
.Memebers-added { grid-area: Memebers-added; }

.Chat-title { grid-area: Chat-title; }

.chat-description { grid-area: chat-description; }

.Add-memebers { grid-area: Add-memebers; }

.chats-image { grid-area: chats-image;}

.Create { grid-area: Create;
text-align: center; }


  </style>
{% endblock %}

{% block content_title %}
Create New Chat
{% endblock %}


{% block body_block %}

<form id="user_form" method="post" action="" enctype="multipart/form-data">
{% csrf_token %}
<div class="container-fluid p-2 g-2 box">
  <div class="row g-5 justify-content-center align-items-top myrows mb-3">
    <div class="col">
      <div class = "mycol">Members added
        <div>
          <ul class = "lists" id="memberList" style = "list-style-type: none; margin:0;padding:0; height:12rem;"></ul>
        </div>
      </div>
      </div>
    <div class="col">
      <div class="container-fluid" style="padding:0px;">
        <div class = "mycol" style="margin-bottom:10px;">
          <div class="mb-3">
          <label for="ChatName" class="form-label">Chat Name</label>
          <input type="text" class="form-control" id="ChatName" name="name" placeholder="Enter Chat Name" required>
        </div>
      </div>
        <div class = "mycol">
          <div class="mb-3">
            <label for="Chat-title" class="form-label" >Chat Description</label>
            <input type="text" class="form-control" name="description" id="title" placeholder="Enter Chat Description" required>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="row g-6 justify-content-center align-items-top myrows mb-3">
    <div class="col mb-3">
      <div class="mycol">
        <label for="ChatName" class="form-label">Add Member</label>
        <div class="input-group">
          <input type="text" class="form-control" id="memberInput" placeholder="Enter Member Name">
        </div>

        <button type="button" class="btn btn-primary" id="addMemberButton">Add</button>
        </div>
        
        <input type="hidden" id="memberListInput" name="user_list" value="">
        {% for user in all_users %}
            <input type="hidden" name="users" value="{{ user.id }}">
        {% endfor %} 
        <input type="hidden" name="owner" value="{{ request.user.userprofile.id }}"> 

        <script>
          const memberInput = document.getElementById("memberInput");
          const addMemberButton = document.getElementById("addMemberButton");
          const memberListInput = document.getElementById("memberListInput");
          const members = [];
          
          var usernames = JSON.parse('{{ usernames|escapejs }}');
          const currentUser = JSON.parse('{{ current_user|escapejs }}')
          addMemberButton.addEventListener("click", function() {
            const memberName = memberInput.value;
            if (memberName !== "") {
              const user = usernames.find(u => u === memberName);
              if (user) {
                if (members.includes(user)){
                  alert(`User ${memberName} is already in the chat.`);
                } 
                else if (user === currentUser) {
                  alert(`You cannot add yourself to the chat.`);
                }
                else {
                  members.push(user);
                  memberInput.value = "";
                  renderMembers();
                  updateMemberListInput();
                }
            } else {
                alert(`User ${memberName} not found.`);
            }
            }
          });
          
          function renderMembers() {
            memberList.innerHTML = "";
            for (let i = 0; i < members.length; i++) {
              const li = document.createElement("li");
              const close = document.createElement("a");
              close.textContent="close";
              close.classList.add('material-symbols-outlined');
              close.classList.add("float-right");
              close.classList.add("close-button");
              close.onclick=function(){
                  members.splice(i,1);
                  renderMembers();
              }
              li.textContent = members[i];
              li.classList.add('profile-chip');
              li.appendChild(close);
              memberList.appendChild(li);
            }
          }

          function updateMemberListInput() {
            memberListInput.value = JSON.stringify(members);
          }
        </script>

      </div>
    </div>
    <div class="col">
      <div class = "mycol">
        <label for="UploadImage" class="form-label">Upload Background Image</label>
        <input class="form-control form-control-lg" name="image" id="UploadImage" type="file">
      </div>
    </div>
  </div>
  <div class="row justify-content-center align-items-top myrows mb-3">
    <div class="col-1 justify-content-center align-items-center">
      <button class="btn btn-light urlbuttons" type="submit" style="position: relative;">Create</button>
    </div>
  </div>
</div>
</form>
{% endblock %}
