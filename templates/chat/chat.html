{% extends 'chat/chattemplates.html' %}
{% load staticfiles %}

{% block title_block %}
{{chat_name}}
{% endblock %}

{% block includes_block %}
{% endblock %}

{% block content_title %}
{{chat_name}}
{% if current_user == owner %}
<div class="btn-group float-right" role="group" aria-label="Chat Buttons">
    <a class="btn btn-primary" href="{% url 'chat:chatroom' chat_name_slug %}">Home</a>
    <a class="btn btn-primary" href="{% url 'chat:members' chat_name_slug %}">Members</a>
    <a class="btn btn-primary" href="{% url 'chat:files' chat_name_slug %}">Files</a>
    <a class="btn btn-primary" href="{% url 'chat:delete' chat_name_slug %}" onclick = "return confirm('Are you sure you want to delete?')">Delete Chat</a>
</div>
{% else %}
<div class="btn-group float-right" role="group" aria-label="Chat Buttons">
    <a class="btn btn-primary" href="{% url 'chat:chatroom' chat_name_slug %}">Home</a>
    <a class="btn btn-primary" href="{% url 'chat:members' chat_name_slug %}">Members</a>
    <a class="btn btn-primary" href="{% url 'chat:files' chat_name_slug %}">Files</a>
    <a class="btn btn-primary" href="{% url 'chat:leave' chat_name_slug %}" onclick = "return confirm('Are you sure you want to leave?')">Leave Chat</a>
</div>
{% endif %}
{% endblock %}
{% block body_block %}
{{ this_username|json_script:"this-username" }}
{{ chat_name_slug|json_script:"chat-slug" }}
<body>
    <div class="row h-100">
        <div class="col h-75 w-100 position-relative">
            <div id="messagesList" class="d-block chat-message-list h-75 w-100 overflow-scroll scrollable">
            </div>
            <div class="input-group mb-5 bottom-0 w-100 d-flex">
              <input type="text" class="form-control" placeholder="Your message here" id="message-input">
              <button class="btn btn-outline-secondary" type="button" id="send-button">Send</button>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            updateMessages();
            window.setInterval(updateMessages, 1000);
            $("#send-button").click(function() {
                let username = "{{this_username|escapejs}}";
                let slug = "{{chat_name_slug|escapejs}}";
                let content = $("#message-input").val();
                $.get('send_message', {'content':content,'username':username,'chat_slug':slug}, updateMessages);
            });
        });

        function updateMessages() {
            let slug = "{{chat_name_slug|escapejs}}";
            $.get('get_messages',
                {'chat_slug':slug},
                function(data) {
                    let messages = JSON.parse(data);
                    let messagesList = $("#messagesList");
                    messagesList.empty();
                    for(let i=0; i < messages.length; i++) {
                        m = document.createElement("li");
                        messages[i].content;
                        m.textContent=messages[i].sender+":"+messages[i].content;
                        messagesList.append(m);
                    }
                });
        }

    </script>
</body>
{% endblock %}
